<html>
<head>
    
    <title>Activiti流程引擎学习</title>
    <meta name="keywords" content="luxiang.org,卢翔,卢翔的blog" />

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    
    <link href="/css/main.css?v=3" rel="stylesheet" type="text/css" />

    
<script src="/js/util.js"></script>

    <script>
        if (isMobile()) {
            loadjscssfile('/css/mobile.css', 'css');
        } else {
            loadjscssfile('/css/desktop.css', 'css');
        }
    </script>
    

    <link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Atom feed">

    
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=3" />
    
    
<meta name="generator" content="Hexo 4.2.0"></head>
<body>
<style>
    .highlight {
        position: relative;
    }

    .btn-copy {
        display: inline-block;
        cursor: pointer;
        background-color: #eee;
        background-image: linear-gradient(#fcfcfc, #eee);
        border: 1px solid #d5d5d5;
        border-radius: 3px;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        -webkit-appearance: none;
        font-size: 13px;
        font-weight: 700;
        line-height: 20px;
        color: #333;
        -webkit-transition: opacity .3s ease-in-out;
        -o-transition: opacity .3s ease-in-out;
        transition: opacity .3s ease-in-out;
        padding: 2px 6px;
        position: absolute;
        right: 5px;
        top: 5px;
        opacity: 0;
    }

    .btn-copy span {
        margin-left: 5px;
    }

    .highlight:hover .btn-copy {
        opacity: 1;
    }
</style>


<h2 class="title">Activiti流程引擎学习</h2>
<!---
<div style="text-align:center;margin-top: -10px;">
<div class="article-category">
发表于2021年3月1日




 </div>
--->
</div>

<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#什么是BPMN（Business-Process-Model-and-Notation）"><span class="toc-text">什么是BPMN（Business Process Model and Notation）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#概述"><span class="toc-text">概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#历史"><span class="toc-text">历史</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#基本组成"><span class="toc-text">基本组成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#怎么通过BPMN描述一个工作流程？"><span class="toc-text">怎么通过BPMN描述一个工作流程？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#什么是Activiti"><span class="toc-text">什么是Activiti</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#历史-1"><span class="toc-text">历史</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Activiti使用"><span class="toc-text">Activiti使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Activiti几个核心的接口"><span class="toc-text">Activiti几个核心的接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据库表设计"><span class="toc-text">数据库表设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#导入BPMN文件"><span class="toc-text">导入BPMN文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动流程实例"><span class="toc-text">启动流程实例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Task审批"><span class="toc-text">Task审批</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Task逻辑自动处理"><span class="toc-text">Task逻辑自动处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#流程实例监听"><span class="toc-text">流程实例监听</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#遇到的问题"><span class="toc-text">遇到的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring-boot-初始化表格报错"><span class="toc-text">Spring boot 初始化表格报错</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#扩展阅读"><span class="toc-text">扩展阅读</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#什么是Flowable"><span class="toc-text">什么是Flowable</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#什么是Activiti-Cloud"><span class="toc-text">什么是Activiti Cloud</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Jeesite"><span class="toc-text">Jeesite</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-text">参考</span></a></li></ol>
<h2 id="什么是BPMN（Business-Process-Model-and-Notation）"><a href="#什么是BPMN（Business-Process-Model-and-Notation）" class="headerlink" title="什么是BPMN（Business Process Model and Notation）"></a>什么是BPMN（Business Process Model and Notation）</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>业务流程模型和标记法（BPMN, Business Process Model and Notation）是对象管理组织（OMG, Object Management Group）维护的关于业务流程建模的行业性标准。它创建在与UML的活动图非常相似的流程图法（flowcharting）基础上，为“业务流程图”（BPD, Business Process Diagram）中的特定业务流程提供一套图形化标记法。BPMN的目标是，通过提供一套既符合业务人员直观又能表现复杂流程语义的标记法，同时为技术人员和业务人员从事业务流程管理提供支持。BPMN规范还提供从标记法的图到执行语言基础构造的映射，尤其是业务流程执行语言（BPEL）。</p>
<p>BPMN的首要目的是提供全体业务相关者易于理解的标准标记法。业务相关者包括创造与梳理流程的业务分析师、负责实施流程的技术开发者、以及管理和监督流程的经理人。BPMN旨在充当公共语言，跨越业务流程设计和实施之间常见的鸿沟。</p>
<p>当前有多种竞争的业务流程建模语言标准供建模过程和工具选用。广泛采用BPMN将有助于统一基本的业务流程概念的表达（例如：公共或私有的流程、编排），就像一些高级的业务概念一样（例如：例外处理、事务补偿）。</p>
<h3 id="历史"><a href="#历史" class="headerlink" title="历史"></a>历史</h3><p>BPMN最初由业务流程管理倡议组织（BPMI, Business Process Management Initiative）开发，该组织于2005年与对象管理组织（OMG, Object Management Group）合并，从那时起，由OMG维护。BPMN最初的名称为”Business Process Modeling Notation”，即“业务流程建模标记法”，2011年1月OMG发布2.0版本，同时改为现在的名称。</p>
<h3 id="基本组成"><a href="#基本组成" class="headerlink" title="基本组成"></a>基本组成</h3><ul>
<li>流对象（Flow Object）<ul>
<li>事件（Events）<ul>
<li>开始事件（Start event）</li>
<li>结束事件（End event）</li>
<li>中间事件（Intermediate event）</li>
</ul>
</li>
<li>活动（Activities）<ul>
<li>任务（Task）</li>
<li>子流程（Sub-process）</li>
<li>事务（Transaction）</li>
</ul>
</li>
<li>网关（Gateways）<ul>
<li>排他网关（Exclusive Gateway）</li>
<li>Exclusive Gateway Example</li>
<li>Parallel Gateway</li>
<li>Inclusive Gateway</li>
<li>Exclusive Event-based Gateway</li>
<li>Complex Decision Gateway</li>
<li>Parallel Event-Based Gateway</li>
</ul>
</li>
</ul>
</li>
<li>连接对象（Connecting Objects）<ul>
<li>顺序流（Sequence Flow）</li>
<li>消息流（Message Flow）</li>
<li>关联（Association）</li>
</ul>
</li>
<li>泳道（Swimlanes）<ul>
<li>池（Pool）</li>
<li>道（Lane）</li>
</ul>
</li>
<li>器物（Artifacts/Artefacts）<ul>
<li>数据对象（Data Object）</li>
<li>组（Group）</li>
<li>注释（Annotation）</li>
</ul>
</li>
</ul>
<h3 id="怎么通过BPMN描述一个工作流程？"><a href="#怎么通过BPMN描述一个工作流程？" class="headerlink" title="怎么通过BPMN描述一个工作流程？"></a>怎么通过BPMN描述一个工作流程？</h3><p>假设有这么一个场景：</p>
<p>学生申请请假，请假天数为变量day；</p>
<p>当day小于等于2时，只需要班主任审批通过；</p>
<p>当day大于2小于等于7时，同时需要班主任和院领导依次审批通过；</p>
<p>当day大于7时，同时需要班主任、院领导和校领导依次审批通过；</p>
<hr>
<p>通过BPMN绘制的图如下：</p>
<center>
    <img src="leave_stu.jpg" width="100%" height="100%">
    <br>
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">学生请假流程</div>
</center>

<hr>
<h2 id="什么是Activiti"><a href="#什么是Activiti" class="headerlink" title="什么是Activiti"></a>什么是Activiti</h2><p>Activiti是用Java编写的开源 工作流引擎，可以执行BPMN 2.0中描述的业务流程。 Activiti是Alfresco Alfresco过程服务（APS）的基础，而Alfresco是Activiti项目的主要赞助商。</p>
<h3 id="历史-1"><a href="#历史-1" class="headerlink" title="历史"></a>历史</h3><p>2010年3月，jBPM的两个主要开发人员Tom Baeyens和Joram Barrez离开了Red Hat，并以Alfresco的雇员的身份创立了Activiti 。Activiti基于他们在jBPM上的工作流程经验，但它是一个新的代码库，而不是基于任何以前的jBPM代码。</p>
<p>Activiti的第一个版本是5.0，表明产品是他们通过jBPM 1到4获得的经验的延续。</p>
<p>2016年10月，Barrez，Rademakers（Activiti in Action 的作者）和其他贡献者离开了Alfresco。即将离任的开发人员分叉了Activiti代码以启动一个名为Flowable的新项目。</p>
<p>2017年2月，发布了新的Activiti商业版，并将其更名为Alfresco Process Services。</p>
<p>2017年5月，Activiti发布了版本6.0.0 ，其中对ad-hoc子流程提供了新的支持，并提供了新的应用程序用户界面。</p>
<blockquote>
<p><a href="https://web.archive.org/web/20161230085710/https://www.enterpriseirregulars.com/110881/another-rift-open-source-bpm-market-flowablebpm-forks-alfresco-activiti/" target="_blank" rel="noopener">Another rift in the open source BPM market</a></p>
</blockquote>
<blockquote>
<p><a href="https://web.archive.org/web/20161230090047/http://ecmarchitect.com/archives/2016/10/15/4192" target="_blank" rel="noopener">Activiti founders fork the project to create Flowable, an open source BPM engine</a></p>
</blockquote>
<hr>
<h2 id="Activiti使用"><a href="#Activiti使用" class="headerlink" title="Activiti使用"></a>Activiti使用</h2><h3 id="Activiti几个核心的接口"><a href="#Activiti几个核心的接口" class="headerlink" title="Activiti几个核心的接口"></a>Activiti几个核心的接口</h3><table>
<thead>
<tr>
<th align="left">类名称</th>
<th align="left">用途</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><a href="https://www.activiti.org/javadocs/org/activiti/engine/DynamicBpmnService.html" target="_blank" rel="noopener">DynamicBpmnService</a></td>
<td align="left">提供对流程定义和部署存储库的访问的服务。</td>
</tr>
<tr>
<td align="left"><a href="https://www.activiti.org/javadocs/org/activiti/engine/EngineServices.html" target="_blank" rel="noopener">EngineServices</a></td>
<td align="left">由所有公开Activiti服务的类实现的接口。</td>
</tr>
<tr>
<td align="left"><a href="https://www.activiti.org/javadocs/org/activiti/engine/FormService.html" target="_blank" rel="noopener">FormService</a></td>
<td align="left"></td>
</tr>
<tr>
<td align="left"><a href="https://www.activiti.org/javadocs/org/activiti/engine/HistoryService.html" target="_blank" rel="noopener">HistoryService</a></td>
<td align="left">服务公开有关正在进行和过去的流程实例的信息。</td>
</tr>
<tr>
<td align="left"><a href="https://www.activiti.org/javadocs/org/activiti/engine/RuntimeService.html" target="_blank" rel="noopener">IdentityService</a></td>
<td align="left">管理用户和用户组的操作</td>
</tr>
<tr>
<td align="left"><a href="https://www.activiti.org/javadocs/org/activiti/engine/ManagementService.html" target="_blank" rel="noopener">ManagementService</a></td>
<td align="left">在流程引擎上进行管理和维护操作的服务</td>
</tr>
<tr>
<td align="left"><a href="https://www.activiti.org/javadocs/org/activiti/engine/RuntimeService.html" target="_blank" rel="noopener">ProcessEngine</a></td>
<td align="left">提供对公开BPM和工作流操作的所有服务的访问</td>
</tr>
<tr>
<td align="left"><a href="https://www.activiti.org/javadocs/org/activiti/engine/ProcessEngineInfo.html" target="_blank" rel="noopener">ProcessEngineInfo</a></td>
<td align="left">表示有关流程引擎初始化的信息</td>
</tr>
<tr>
<td align="left"><a href="https://www.activiti.org/javadocs/org/activiti/engine/ProcessEngineLifecycleListener.html" target="_blank" rel="noopener">ProcessEngineLifecycleListener</a></td>
<td align="left">描述监听器的接口，该监听器在发生特定事件时会得到通知，与其关联的流程引擎生命周期相关</td>
</tr>
<tr>
<td align="left"><a href="https://www.activiti.org/javadocs/org/activiti/engine/RepositoryService.html" target="_blank" rel="noopener">RepositoryService</a></td>
<td align="left">提供对流程定义和部署存储库的访问的服务。</td>
</tr>
<tr>
<td align="left"><a href="https://www.activiti.org/javadocs/org/activiti/engine/RuntimeService.html" target="_blank" rel="noopener">RuntimeService</a></td>
<td align="left">提供对流程控制的操作</td>
</tr>
<tr>
<td align="left"><a href="https://www.activiti.org/javadocs/org/activiti/engine/TaskService.html" target="_blank" rel="noopener">TaskService</a></td>
<td align="left">提供访问Task相关的操作</td>
</tr>
</tbody></table>
<center>
    <br>
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">Activiti主要API</div>
</center>

<h3 id="数据库表设计"><a href="#数据库表设计" class="headerlink" title="数据库表设计"></a>数据库表设计</h3><p>Activiti引擎表结构设计如下：</p>
<center>
    <img src="activiti.png" width="100%" height="100%">
    <br>
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">Activiti表结构</div>
</center>

<hr>
<p>业务数据表结构如下：</p>
<center>
    <img src="business_db.png" width="30%" height="100%">
    <br>
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">业务数据表结构</div>
</center>

<hr>
<p>不同前缀的表说明：</p>
<ul>
<li>ACT_RE_*: ‘RE’表示repository。 这个前缀的表包含了流程定义和流程静态资源 （图片，规则，等等）。</li>
<li>ACT_RU_*: ‘RU’表示runtime。 这些运行时的表，包含流程实例，任务，变量，异步任务，等运行中的数据。 Activiti只在流程实例执行过程中保存这些数据， 在流程结束时就会删除这些记录。 这样运行时表可以一直很小速度很快。</li>
<li><del>ACT_ID_*: ‘ID’表示identity。 这些表包含身份信息，比如用户，组等等。</del></li>
<li>ACT_HI_*: ‘HI’表示history。 这些表包含历史数据，比如历史流程实例， 变量，任务等等。</li>
<li>ACT_GE_*: 通用数据， 用于不同场景下，如存放资源文件。</li>
</ul>
<table>
<thead>
<tr>
<th align="left">表名</th>
<th align="left">用途</th>
<th align="left">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="left">ACT_EVT_LOG</td>
<td align="left">事件处理日志</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">ACT_GE_BYTEARRAY</td>
<td align="left">二进制数据表</td>
<td align="left">存储流程定义相关的部署信息。即流程定义文档的存放地。每部署一次就会增加两条记录，一条是关于BPMN规则文件的，一条是图片的（如果部署时只指定了BPMN一个文件，Activiti会在部署时解析BPMN文件内容自动生成流程图）。两个文件不是很大，都是以二进制形式存储在数据库中。</td>
</tr>
<tr>
<td align="left">ACT_GE_PROPERTY</td>
<td align="left">主键生成表</td>
<td align="left">主张表将生成下次流程部署的主键ID。</td>
</tr>
<tr>
<td align="left">ACT_HI_ACTINST</td>
<td align="left">历史节点表</td>
<td align="left">只记录usertask内容,某一次流程的执行一共经历了多少个活动</td>
</tr>
<tr>
<td align="left">ACT_HI_ATTACHMENT</td>
<td align="left">历史附件表</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">ACT_HI_COMMENT</td>
<td align="left">历史意见表</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">ACT_HI_DETAIL</td>
<td align="left">历史详情表，提供历史变量的查询</td>
<td align="left">流程中产生的变量详细，包括控制流程流转的变量等</td>
</tr>
<tr>
<td align="left">ACT_HI_IDENTITYLINK</td>
<td align="left">历史流程人员表</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">ACT_HI_PROCINST</td>
<td align="left">历史流程实例表</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">ACT_HI_TASKINST</td>
<td align="left">历史任务实例表</td>
<td align="left">一次流程的执行一共经历了多少个任务</td>
</tr>
<tr>
<td align="left">ACT_HI_VARINST</td>
<td align="left">历史变量表</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">ACT_PROCDEF_INFO</td>
<td align="left"></td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">ACT_RE_DEPLOYMENT</td>
<td align="left">部署信息表</td>
<td align="left">存放流程定义的显示名和部署时间，每部署一次增加一条记录</td>
</tr>
<tr>
<td align="left">ACT_RE_MODEL</td>
<td align="left">流程设计模型部署表</td>
<td align="left">流程设计器设计流程后，保存数据到该表</td>
</tr>
<tr>
<td align="left">ACT_RE_PROCDEF</td>
<td align="left">流程定义数据表</td>
<td align="left">存放流程定义的属性信息，部署每个新的流程定义都会在这张表中增加一条记录。注意：当流程定义的key相同的情况下，使用的是版本升级</td>
</tr>
<tr>
<td align="left">ACT_RU_DEADLETTER_JOB</td>
<td align="left">-</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">ACT_RU_EVENT_SUBSCR</td>
<td align="left">throwEvent，catchEvent时间监听信息表</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">ACT_RU_EXECUTION</td>
<td align="left">运行时流程执行实例表</td>
<td align="left">历史流程变量</td>
</tr>
<tr>
<td align="left">ACT_RU_IDENTITYLINK</td>
<td align="left">运行时流程人员表</td>
<td align="left">主要存储任务节点与参与者的相关信息</td>
</tr>
<tr>
<td align="left">ACT_RU_INTEGRATION</td>
<td align="left">-</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">ACT_RU_JOB</td>
<td align="left">运行时定时任务数据表</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">ACT_RU_SUSPENDED_JOB</td>
<td align="left">-</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">ACT_RU_TASK</td>
<td align="left">运行时任务节点表</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">ACT_RU_TIMER_JOB</td>
<td align="left">-</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">ACT_RU_VARIABLE</td>
<td align="left">运行时流程变量数据表</td>
<td align="left">通过JavaBean设置的流程变量，在act_ru_variable中存储的类型为serializable，变量真正存储的地方在act_ge_bytearray中。</td>
</tr>
</tbody></table>
<hr>
<h3 id="导入BPMN文件"><a href="#导入BPMN文件" class="headerlink" title="导入BPMN文件"></a>导入BPMN文件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation</span>(summary = <span class="string">"部署工作流设计"</span>, description = <span class="string">"部署工作流设计"</span>)</span><br><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"/deploy"</span>, consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deployProcess</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        @Schema(description = <span class="string">"流程设计文件"</span>)</span> MultipartFile file,</span></span><br><span class="line"><span class="function">        @<span class="title">Schema</span><span class="params">(description = <span class="string">"部署名称"</span>)</span></span></span><br><span class="line"><span class="function">        @<span class="title">RequestParam</span><span class="params">()</span> String name,</span></span><br><span class="line"><span class="function">        @<span class="title">Schema</span><span class="params">(description = <span class="string">"部署key"</span>)</span></span></span><br><span class="line"><span class="function">        @<span class="title">RequestParam</span><span class="params">()</span> String key,</span></span><br><span class="line"><span class="function">        @<span class="title">Schema</span><span class="params">(description = <span class="string">"分类"</span>)</span></span></span><br><span class="line"><span class="function">        @<span class="title">RequestParam</span><span class="params">()</span> String category,</span></span><br><span class="line"><span class="function">        @<span class="title">Schema</span><span class="params">(description = <span class="string">"租户ID"</span>)</span></span></span><br><span class="line"><span class="function">        @<span class="title">RequestParam</span><span class="params">(required = <span class="keyword">false</span>)</span> String tenantId) </span>&#123;</span><br><span class="line">    String filename = file.getOriginalFilename();</span><br><span class="line">    <span class="keyword">try</span> (InputStream fileInputStream = file.getInputStream()) &#123;</span><br><span class="line">        repositoryService.createDeployment()<span class="comment">//初始化流程</span></span><br><span class="line">                .addInputStream(filename, fileInputStream)</span><br><span class="line">                .name(name)</span><br><span class="line">                .tenantId(tenantId)</span><br><span class="line">                .key(key)</span><br><span class="line">                .category(category)</span><br><span class="line">                .deploy();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="启动流程实例"><a href="#启动流程实例" class="headerlink" title="启动流程实例"></a>启动流程实例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">insertLeave</span><span class="params">(HttpServletRequest request, Leave leave)</span> </span>&#123;</span><br><span class="line">    Map&lt;String, Object&gt; params = CommonUtils.getParametersStartingWith(request,</span><br><span class="line">            GlobalConstant.ACTIVITI_PARAMS_PREFIX);</span><br><span class="line">    String businessKey = <span class="string">"leave:"</span> + UUID.randomUUID().toString();</span><br><span class="line"></span><br><span class="line">    StartProcessPayloadBuilder builder = ProcessPayloadBuilder</span><br><span class="line">            .start()</span><br><span class="line">            .withProcessDefinitionKey(<span class="string">"leave_stu"</span>)</span><br><span class="line">            .withName(<span class="string">"leave_stu"</span>)</span><br><span class="line">            .withBusinessKey(businessKey);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!CollectionUtils.isEmpty(params)) &#123;</span><br><span class="line">        builder.withVariables(params);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    StartProcessPayload processPayload = builder</span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line">    ProcessInstance processInstance = processRuntime.start(processPayload);</span><br><span class="line">    String procInstId = processInstance.getId();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    leave.setProcInstId(procInstId);</span><br><span class="line">    leave.setBusinessKey(businessKey);</span><br><span class="line">    <span class="keyword">return</span> leaveMapper.insertLeave(leave);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Task审批"><a href="#Task审批" class="headerlink" title="Task审批"></a>Task审批</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">check</span><span class="params">(HttpServletRequest request, String taskId)</span> </span>&#123;</span><br><span class="line">    Task task = taskService.createTaskQuery().taskId(taskId).singleResult();</span><br><span class="line">    ProcessInstance processInstance = processRuntime.processInstance(task.getProcessInstanceId());</span><br><span class="line">    String businessKey = processInstance.getBusinessKey();</span><br><span class="line">    String formKey = task.getFormKey();</span><br><span class="line">    String taskName = task.getName();</span><br><span class="line">    Date current = <span class="keyword">new</span> Date();</span><br><span class="line"></span><br><span class="line">    String username = (String) session.getAttribute(GlobalConstant.CUR_USERNAME);</span><br><span class="line"></span><br><span class="line">    Map&lt;String, Object&gt; params = CommonUtils.getParametersStartingWith(request,</span><br><span class="line">            GlobalConstant.ACTIVITI_PARAMS_PREFIX);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!CollectionUtils.isEmpty(params)) &#123;</span><br><span class="line">        taskService.complete(task.getId(), params);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        taskService.complete(task.getId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UserTask userTask = (UserTask) repositoryService.getBpmnModel(task.getProcessDefinitionId())</span><br><span class="line">            .getFlowElement(formKey);</span><br><span class="line"></span><br><span class="line">    List&lt;FormProperty&gt; formProperties = userTask.getFormProperties();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (FormProperty formProperty : formProperties) &#123;</span><br><span class="line">        String id = formProperty.getId();</span><br><span class="line">        String name = formProperty.getName();</span><br><span class="line">        String value = (String) params.get(id);</span><br><span class="line"></span><br><span class="line">        WorkflowFormdata workflowFormdata = <span class="keyword">new</span> WorkflowFormdata();</span><br><span class="line">        workflowFormdata.setBusinessKey(businessKey);</span><br><span class="line">        workflowFormdata.setFormKey(formKey);</span><br><span class="line">        workflowFormdata.setControlId(id);</span><br><span class="line">        workflowFormdata.setControlName(name);</span><br><span class="line">        workflowFormdata.setControlValue(value);</span><br><span class="line">        workflowFormdata.setTaskNodeName(taskName);</span><br><span class="line">        workflowFormdata.setCreateBy(username);</span><br><span class="line">        workflowFormdata.setCreateTime(current);</span><br><span class="line">        workflowFormdataMapper.insertWorkflowFormdata(workflowFormdata);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Task逻辑自动处理"><a href="#Task逻辑自动处理" class="headerlink" title="Task逻辑自动处理"></a>Task逻辑自动处理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line"></span><br><span class="line">### 撤回功能</span><br><span class="line"></span><br><span class="line">```java</span><br></pre></td></tr></table></figure>

<h3 id="流程实例监听"><a href="#流程实例监听" class="headerlink" title="流程实例监听"></a>流程实例监听</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sd.activiti.listen;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sd.activiti.domain.Leave;</span><br><span class="line"><span class="keyword">import</span> com.sd.activiti.service.LeaveService;</span><br><span class="line"><span class="keyword">import</span> com.sd.activiti.utils.SpringContextUtil;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.delegate.DelegateExecution;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.delegate.ExecutionListener;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.delegate.Expression;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LeaveEndStateListener</span> <span class="keyword">implements</span> <span class="title">ExecutionListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(LeaveEndStateListener<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Expression state;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(DelegateExecution delegateExecution)</span> </span>&#123;</span><br><span class="line">        LeaveService leaveService = SpringContextUtil.getBean(<span class="string">"leaveServiceImpl"</span>, LeaveService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        String businessKey = delegateExecution.getProcessInstanceBusinessKey();</span><br><span class="line">        String value = state.getValue(delegateExecution).toString();</span><br><span class="line">        log.info(<span class="string">"bus_key:&#123;&#125;, value:&#123;&#125;"</span>, businessKey, value);</span><br><span class="line">        Leave leave = leaveService.selectLeaveByBusinessKey(businessKey);</span><br><span class="line">        leave.setState(Integer.valueOf(value));</span><br><span class="line">        leaveService.updateLeave(leave);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><hr>
<h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><h3 id="Spring-boot-初始化表格报错"><a href="#Spring-boot-初始化表格报错" class="headerlink" title="Spring boot 初始化表格报错"></a>Spring boot 初始化表格报错</h3><p>  如果同一个数据库地址下面有多个库，当其中某个库已经生成过表时。别的库生成数据库的时候会报错。在数据库URL后面加上参数<code>nullCatalogMeansCurrent=true</code><br>例如：<code>jdbc:mysql://127.0.0.1:3306/activiti?nullCatalogMeansCurrent=true</code>  </p>
<blockquote>
<p><a href="https://blog.csdn.net/jiaoshaoping/article/details/80748065" target="_blank" rel="noopener">深入分析mysql 6.0.6 和 activiti 6.0.0自动创建表失败的问题</a></p>
</blockquote>
<h2 id="扩展阅读"><a href="#扩展阅读" class="headerlink" title="扩展阅读"></a>扩展阅读</h2><h3 id="什么是Flowable"><a href="#什么是Flowable" class="headerlink" title="什么是Flowable"></a>什么是Flowable</h3><p>官方解释：</p>
<blockquote>
<p>Flowable is a light-weight business process engine written in Java. The Flowable process engine allows you to deploy BPMN 2.0 process definitions (an industry XML standard for defining processes), creating process instances of those process definitions, running queries, accessing active or historical process instances and related data, plus much more. This section will gradually introduce various concepts and APIs to do that through examples that you can follow on your own development machine.</p>
</blockquote>
<blockquote>
<p>Flowable is extremely flexible when it comes to adding it to your application/services/architecture. You can embed the engine in your application or service by including the Flowable library, which is available as a JAR. Since it’s a JAR, you can add it easily to any Java environment: Java SE; servlet containers, such as Tomcat or Jetty, Spring; Java EE servers, such as JBoss or WebSphere, and so on. Alternatively, you can use the Flowable REST API to communicate over HTTP. There are also several Flowable Applications (Flowable Modeler, Flowable Admin, Flowable IDM and Flowable Task) that offer out-of-the-box example UIs for working with processes and tasks.</p>
</blockquote>
<blockquote>
<p>Common to all the ways of setting up Flowable is the core engine, which can be seen as a collection of services that expose APIs to manage and execute business processes. The various tutorials below start by introducing how to set up and use this core engine. The sections afterwards build upon the knowledge acquired in the previous sections.</p>
</blockquote>
<ul>
<li>The first section shows how to run Flowable in the simplest way possible: a regular Java main using only Java SE. Many core concepts and APIs will be explained here.</li>
<li>The section on the Flowable REST API shows how to run and use the same API through REST.</li>
<li>The section on the Flowable App, will guide you through the basics of using the out-of-the-box example Flowable user interfaces.</li>
</ul>
<hr>
<p>Google翻译如下：</p>
<blockquote>
<p>Flowable是用Java编写的轻量级业务流程引擎。Flowable流程引擎允许您部署BPMN 2.0流程定义（用于定义流程的行业XML标准），创建这些流程定义的流程实例，运行查询，访问活动或历史流程实例以及相关数据，以及更多其他功能。本节将通过示例在您自己的开发计算机上逐步介绍各种概念和API，以实现此目的。</p>
</blockquote>
<blockquote>
<p>当将Flowable添加到您的应用程序/服务/体系结构中时，它非常灵活。您可以通过包含Flowable库将引擎嵌入引擎到应用程序或服务中，该库可以作为JAR使用。由于它是一个JAR，因此您可以轻松地将其添加到任何Java环境中：Java SE; Java SE; Java SE; Java SE。Servlet容器，例如Tomcat或Jetty，Spring；Java EE服务器，例如JBoss或WebSphere，等等。或者，您可以使用Flowable REST API通过HTTP进行通信。还有一些Flowable应用程序（Flowable Modeler，Flowable Admin，Flowable IDM和Flowable Task），它们提供了开箱即用的示例UI，用于处理流程和任务。</p>
</blockquote>
<blockquote>
<p>设置Flowable的所有方式的共同点是核心引擎，它可以看作是服务的集合，这些服务公开了API来管理和执行业务流程。下面的各种教程首先介绍如何设置和使用此核心引擎。随后的各节将以前面各节中获得的知识为基础。</p>
</blockquote>
<ul>
<li>在首节仅使用Java SE普通的Java主：展示了如何在可能的最简单的方式运行到流动性。这里将解释许多核心概念和API。</li>
<li>关于Flowable REST API的部分显示了如何通过REST运行和使用相同的API。</li>
<li>将在可流动的应用部分，将指导您使用出的现成例子可流动的用户界面的基本知识。</li>
</ul>
<hr>
<p>以下是Activiti和Flowable的Roadmap</p>
<ul>
<li><a href="https://github.com/Activiti/Activiti/wiki/Activiti-Roadmap" target="_blank" rel="noopener">Activiti roadmap</a></li>
<li><a href="https://github.com/flowable/flowable-engine/wiki/Flowable-roadmap" target="_blank" rel="noopener">Flowable roadmap</a>  </li>
</ul>
<h3 id="什么是Activiti-Cloud"><a href="#什么是Activiti-Cloud" class="headerlink" title="什么是Activiti Cloud"></a>什么是Activiti Cloud</h3><blockquote>
<p><a href="https://activiti.gitbook.io/activiti-7-developers-guide/overview" target="_blank" rel="noopener">Activiti Cloud Overview</a></p>
</blockquote>
<h3 id="Jeesite"><a href="#Jeesite" class="headerlink" title="Jeesite"></a>Jeesite</h3><p>一个集成了工作流的国产开源项目（<a href="https://opensource.org/licenses/AGPL-3.0" target="_blank" rel="noopener">AGPL-3.0</a>）</p>
<hr>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://www.visual-paradigm.com/guide/bpmn/what-is-bpmn/" target="_blank" rel="noopener">What is BPMN?</a></li>
<li><a href="https://zh.wikipedia.org/wiki/%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B%E6%A8%A1%E5%9E%8B%E5%92%8C%E6%A0%87%E8%AE%B0%E6%B3%95" target="_blank" rel="noopener">BPMN Wiki</a></li>
<li><a href="https://www.bpmn.org/" target="_blank" rel="noopener">OMG BPMN（Object Management Group Business Process Model and Notation）</a></li>
<li><a href="https://www.visual-paradigm.com/guide/bpmn/bpmn-gateway-types/" target="_blank" rel="noopener">BPMN gateway types</a></li>
<li><a href="https://bpmn.io/toolkit/bpmn-js/" target="_blank" rel="noopener">BPMN前端库</a></li>
<li><a href="https://github.com/Activiti" target="_blank" rel="noopener">Activiti Github organization</a></li>
<li><a href="https://github.com/Activiti/Activiti" target="_blank" rel="noopener">Activiti Github 核心仓库</a></li>
<li><a href="https://activiti.gitbook.io/activiti-7-developers-guide/" target="_blank" rel="noopener">Activiti7 Document</a></li>
<li><a href="https://www.activiti.org/userguide/" target="_blank" rel="noopener">Activiti6 Document</a></li>
<li><a href="https://www.activiti.org/javadocs/" target="_blank" rel="noopener">Activiti6 Java Docs</a></li>
<li><a href="https://www.baeldung.com/spring-activiti" target="_blank" rel="noopener">Spring Activiti</a></li>
<li><a href="https://github.com/eugenp/tutorials/tree/master/spring-activiti" target="_blank" rel="noopener">Spring Activiti Github</a></li>
<li><a href="https://dinghuang.github.io/2020/03/14/Activiti7.X%E7%BB%93%E5%90%88SpringBoot2.1%E3%80%81Mybatis/" target="_blank" rel="noopener">Activiti7.X结合SpringBoot2.1、Mybatis</a></li>
<li><a href="https://gitee.com/smell2/ruoyi-vue-activiti" target="_blank" rel="noopener">Ruoyi Vue Activiti</a></li>
<li><a href="https://jeesite.com/" target="_blank" rel="noopener">Jeesite官网</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/340142234" target="_blank" rel="noopener">开发一个简单的SpringBoot activiti应用</a></li>
<li><a href="https://juejin.cn/post/6844903577757057038" target="_blank" rel="noopener">Activiti就是这么简单</a></li>
<li><a href="https://flowable.com/open-source/docs/bpmn/ch02-GettingStarted/" target="_blank" rel="noopener">Flowable入门指导</a></li>
</ul>


<!--<a href="https://luxiang.org/2021/03/01/Activiti%E6%B5%81%E7%A8%8B%E5%BC%95%E6%93%8E%E5%AD%A6%E4%B9%A0/#disqus_thread" class="article-comment-link">Comments</a>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = ''; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
-->
<div style="display:none">
    <script src="http://s4.cnzz.com/stat.php?id=&web_id="
        language="JavaScript"></script>script>
</div>


<script src="/js/jquery-3.5.1.min.js"></script>
<script src="/js/clipboard.min.js"></script>
<script src="/js/clipboard-use.js"></script>

    <script src='https://unpkg.com/mermaid@8.9.1/dist/mermaid.min.js'></script>
    <script>
      if (window.mermaid) {
        mermaid.initialize({theme: 'forest'});
      }
    </script>
  



</body>
</html>