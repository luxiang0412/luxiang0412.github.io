<html>
<head>
    
    <title>Prometheus监控告警简单使用</title>
    <meta name="keywords" content="luxiang.org,卢翔,卢翔的blog" />

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    
    <link href="/css/main.css?v=3" rel="stylesheet" type="text/css" />

    
<script src="/js/util.js"></script>

    <script>
        if (isMobile()) {
            loadjscssfile('/css/mobile.css', 'css');
        } else {
            loadjscssfile('/css/desktop.css', 'css');
        }
    </script>
    

    <link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Atom feed">

    
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=3" />
    
    
<meta name="generator" content="Hexo 4.2.0"></head>
<body>
<style>
    .highlight {
        position: relative;
    }

    .btn-copy {
        display: inline-block;
        cursor: pointer;
        background-color: #eee;
        background-image: linear-gradient(#fcfcfc, #eee);
        border: 1px solid #d5d5d5;
        border-radius: 3px;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        -webkit-appearance: none;
        font-size: 13px;
        font-weight: 700;
        line-height: 20px;
        color: #333;
        -webkit-transition: opacity .3s ease-in-out;
        -o-transition: opacity .3s ease-in-out;
        transition: opacity .3s ease-in-out;
        padding: 2px 6px;
        position: absolute;
        right: 5px;
        top: 5px;
        opacity: 0;
    }

    .btn-copy span {
        margin-left: 5px;
    }

    .highlight:hover .btn-copy {
        opacity: 1;
    }
</style>


<h2 class="title">Prometheus监控告警简单使用</h2>
<!---
<div style="text-align:center;margin-top: -10px;">
<div class="article-category">
发表于2021年5月5日




 </div>
--->
</div>

<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#介绍"><span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#环境说明"><span class="toc-text">环境说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安装和配置"><span class="toc-text">安装和配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Prometheus配置"><span class="toc-text">Prometheus配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Grafana配置"><span class="toc-text">Grafana配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Alertmanager配置"><span class="toc-text">Alertmanager配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Prometheus-webhook-dingtalk配置"><span class="toc-text">Prometheus-webhook-dingtalk配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Alertsnitch配置"><span class="toc-text">Alertsnitch配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#docker-compose启动"><span class="toc-text">docker-compose启动</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-boot-自定义指标"><span class="toc-text">Spring-boot 自定义指标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-text">参考</span></a></li></ol>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><ul>
<li><p>Prometheus</p>
<p>  时序数据库，用来存储和查询监控指标。</p>
</li>
<li><p>Grafana</p>
<p>  数据可视化。可以将Prometheus等数据源的数据进行可视化。</p>
</li>
<li><p>Alertmanager</p>
<p>  Prometheus的警报分为两个部分。Prometheus服务器中的警报规则将警报发送到Alertmanager。该Alertmanager 然后管理这些警报，包括沉默，抑制，聚集和通过的方法，如电子邮件发出通知，Webhook，以及即时通讯平台。</p>
</li>
<li><p>Prometheus-webhook-dingtalk</p>
<p>  集成钉钉，将告警信息推送到钉钉。</p>
</li>
<li><p>Alertsnitch</p>
<p>  集成Mysql或者Postgres，将告警信息存储到数据库。</p>
</li>
</ul>
<h2 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h2><p><strong>注意：</strong>prom-alert-webhook，sub-system-a，sub-system-b这三个应用是另外一个项目<a href="http://10.7.200.214:8929/luxiang/metrics-demo" target="_blank" rel="noopener">metrics-demo</a>的子模块，作为测试用。每个子模块通过路径<code>/actuator/prometheus</code>获取metrics。</p>
<table>
<thead>
<tr>
<th align="left">IP</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">192.168.33.1</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">192.168.33.4</td>
<td align="left">-</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th align="left">服务/应用</th>
<th align="left">IP</th>
<th align="left">端口</th>
<th align="left">类型</th>
<th align="left">Metrics Path</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Prometheus</td>
<td align="left">192.168.33.4</td>
<td align="left">9090</td>
<td align="left">服务</td>
<td align="left"><code>/metrics</code></td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">Grafana</td>
<td align="left">192.168.33.4</td>
<td align="left">3000</td>
<td align="left">服务</td>
<td align="left"><code>/metrics</code></td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">Alertmanager</td>
<td align="left">192.168.33.4</td>
<td align="left">9093</td>
<td align="left">服务</td>
<td align="left"><code>/metrics</code></td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">prometheus-webhook-dingtalk</td>
<td align="left">192.168.33.4</td>
<td align="left">8060</td>
<td align="left">服务</td>
<td align="left">无</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">alertsnitch</td>
<td align="left">192.168.33.4</td>
<td align="left">9567</td>
<td align="left">服务</td>
<td align="left"><code>/metrics</code></td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">prom-alert-webhook</td>
<td align="left">192.168.33.1</td>
<td align="left">8084</td>
<td align="left">应用</td>
<td align="left"><code>/actuator/prometheus</code></td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">sub-system-a</td>
<td align="left">192.168.33.1</td>
<td align="left">8081</td>
<td align="left">应用</td>
<td align="left"><code>/actuator/prometheus</code></td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">sub-system-b</td>
<td align="left">192.168.33.1</td>
<td align="left">8082</td>
<td align="left">应用</td>
<td align="left"><code>/actuator/prometheus</code></td>
<td align="left">-</td>
</tr>
</tbody></table>
<h2 id="安装和配置"><a href="#安装和配置" class="headerlink" title="安装和配置"></a>安装和配置</h2><p>文件目录(prometheus_alert)如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">├── alertsnitch</span><br><span class="line">│   └── mysql</span><br><span class="line">│       ├── 0.0.1-bootstrap.sql</span><br><span class="line">│       └── 0.1.0-fingerprint.sql</span><br><span class="line">├── altermanager_conf</span><br><span class="line">│   └── altermanager.yml</span><br><span class="line">├── docker-compose.yml</span><br><span class="line">├── prometheus_conf</span><br><span class="line">│   ├── instance.alerts.yml</span><br><span class="line">│   ├── prometheus.yml</span><br><span class="line">│   └── test.yml</span><br><span class="line">└── prometheus-webhook-dingtalk</span><br><span class="line">    ├── config.yml</span><br><span class="line">    └── templates</span><br><span class="line">        ├── default.tmpl</span><br><span class="line">        ├── issue43</span><br><span class="line">        │   └── template.tmpl</span><br><span class="line">        └── legacy</span><br><span class="line">            └── template.tmpl</span><br></pre></td></tr></table></figure>

<p>首先拉取镜像：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker pull prom/prometheus:v2.26.0 &amp;&amp; \</span><br><span class="line">  docker pull prom/alertmanager:v0.21.0 &amp;&amp; \</span><br><span class="line">  docker pull grafana/grafana:7.5.5 &amp;&amp; \</span><br><span class="line">  docker pull timonwong/prometheus-webhook-dingtalk:latest &amp;&amp; \</span><br><span class="line">  docker pull luxiang0412/alertsnitch:0.2.1</span><br></pre></td></tr></table></figure>

<p>进入文件目录(prometheus_alert)的根下：</p>
<p><code>cd prometheus_alert</code></p>
<p><strong>下面操作都是在prometheus_alert目录下进行</strong></p>
<h3 id="Prometheus配置"><a href="#Prometheus配置" class="headerlink" title="Prometheus配置"></a>Prometheus配置</h3><p>配置说明</p>
<p>检查prometheus.yml格式是否正确</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm -it --entrypoint=<span class="string">''</span> -v <span class="string">"<span class="variable">$PWD</span>/prometheus_conf:/etc/prometheus_conf"</span> prom/prometheus:v2.26.0 promtool check config /etc/prometheus_conf/prometheus.yml</span><br></pre></td></tr></table></figure>

<p>prometheus.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 全局配置</span></span><br><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">15s</span> <span class="comment"># 抓取指标的间隔</span></span><br><span class="line">  <span class="attr">evaluation_interval:</span> <span class="string">15s</span> <span class="comment"># 计算规则的间隔</span></span><br><span class="line">  <span class="attr">scrape_timeout:</span> <span class="string">10s</span> <span class="comment">#抓取指标超时时间</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Alertmanager配置</span></span><br><span class="line"><span class="attr">alerting:</span></span><br><span class="line">  <span class="attr">alertmanagers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">static_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.33</span><span class="number">.4</span><span class="string">:9093</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 规则文件</span></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">"/etc/prometheus_conf/instance.alerts.yml"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 抓取配置</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="comment"># 名称</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">"prometheus"</span></span><br><span class="line">    <span class="attr">metrics_path:</span> <span class="string">"/metrics"</span></span><br><span class="line">    <span class="attr">scheme:</span> <span class="string">"http"</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> <span class="string">["192.168.33.4:9090"]</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">ip_address:</span> <span class="string">"192.168.33.4"</span></span><br><span class="line">  <span class="comment"># 名称</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">"application"</span></span><br><span class="line">    <span class="attr">metrics_path:</span> <span class="string">"/actuator/prometheus"</span></span><br><span class="line">    <span class="attr">scheme:</span> <span class="string">"http"</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> <span class="string">["192.168.33.1:8081"]</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">ip_address:</span> <span class="string">"192.168.33.1"</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">"application"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> <span class="string">["192.168.33.1:8082"]</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">ip_address:</span> <span class="string">"192.168.33.1"</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">"application"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> <span class="string">["192.168.33.1:8084"]</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">ip_address:</span> <span class="string">"192.168.33.1"</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">"application"</span></span><br></pre></td></tr></table></figure>

<p>检查rules.yml格式是否正确</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm -it --entrypoint=<span class="string">''</span> -v <span class="string">"<span class="variable">$PWD</span>/prometheus_conf:/etc/prometheus_conf"</span> prom/prometheus:v2.26.0 promtool check rules /etc/prometheus_conf/instance.alerts.yml</span><br></pre></td></tr></table></figure>

<p>instance.alerts.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This is the rules file.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">groups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Instance</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">InstanceDown</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">up</span> <span class="string">==</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">5s</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">page</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> down"</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">"<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> of job <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> has been down for more than 5 minutes."</span></span><br><span class="line">    <span class="comment"># 组名</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SdService</span></span><br><span class="line">    <span class="comment"># 规则</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">      <span class="comment"># 警报名称</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">SdServiceDown</span></span><br><span class="line">        <span class="comment"># 表达式</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">sd_service_status</span> <span class="string">==</span> <span class="number">0</span></span><br><span class="line">        <span class="comment"># 持续时间(如果expr为真，且时间大于for的值则触发警报)</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">5s</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">page</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">"sd service <span class="template-variable">&#123;&#123; $labels.application&#125;&#125;</span> down "</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">"sd service <span class="template-variable">&#123;&#123; $labels.application&#125;&#125;</span> down"</span></span><br></pre></td></tr></table></figure>

<p>测试告警规则</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm -it --entrypoint=<span class="string">''</span> -v <span class="string">"<span class="variable">$PWD</span>/prometheus_conf:/etc/prometheus_conf"</span> prom/prometheus:v2.26.0 promtool <span class="built_in">test</span> rules /etc/prometheus_conf/test.yml</span><br></pre></td></tr></table></figure>

<p>test.yml rules测试</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This is the main input for unit testing.</span></span><br><span class="line"><span class="comment"># Only this file is passed as command line argument.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">/etc/prometheus_conf/instance.alerts.yml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">evaluation_interval:</span> <span class="string">1m</span></span><br><span class="line"></span><br><span class="line"><span class="attr">tests:</span></span><br><span class="line">  <span class="comment"># Test 1.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Test-1</span></span><br><span class="line">    <span class="attr">interval:</span> <span class="string">1m</span></span><br><span class="line">    <span class="comment"># Series data.</span></span><br><span class="line">    <span class="attr">input_series:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">series:</span> <span class="string">'up&#123;instance="192.168.33.4:9090", ip_address="192.168.33.4", job="prometheus"&#125;'</span></span><br><span class="line">        <span class="attr">values:</span> <span class="string">"1+0x6 0 0 0 0 0 0 0 0"</span> <span class="comment"># 1 1 1 1 1 1 1 0 0 0 0 0 0 0 0</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">series:</span> <span class="string">'go_goroutines&#123;instance="192.168.33.4:9090", ip_address="192.168.33.4", job="prometheus"&#125;'</span></span><br><span class="line">        <span class="attr">values:</span> <span class="string">"10+10x2 30+20x5"</span> <span class="comment"># 10 20 30 30 50 70 90 110 130</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">series:</span> <span class="string">'sd_service_status&#123;application="prom-alert-webhook", instance="192.168.33.1:8084", ip_address="192.168.33.1", job="application", type="application"&#125;'</span></span><br><span class="line">        <span class="attr">values:</span> <span class="string">"1+0x5 0+0x5"</span> <span class="comment"># 1 1 1 1 1 1 0 0 0 0 0 0</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">series:</span> <span class="string">'sd_service_status&#123;application="sub-system-a", instance="192.168.33.1:8081", ip_address="192.168.33.1", job="application", type="application"&#125;'</span></span><br><span class="line">        <span class="attr">values:</span> <span class="string">"1+0x5 0+0x5"</span> <span class="comment"># 1 1 1 1 1 1 0 0 0 0 0 0</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">series:</span> <span class="string">'sd_service_status&#123;application="sub-system-b", instance="192.168.33.1:8082", ip_address="192.168.33.1", job="application", type="application"&#125;'</span></span><br><span class="line">        <span class="attr">values:</span> <span class="string">"1+0x5 0+0x5"</span> <span class="comment"># 1 1 1 1 1 1 0 0 0 0 0 0</span></span><br><span class="line">    <span class="comment"># Unit test for alerting rules.</span></span><br><span class="line">    <span class="attr">alert_rule_test:</span></span><br><span class="line">      <span class="comment"># Unit test 1.</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">eval_time:</span> <span class="string">10m</span></span><br><span class="line">        <span class="attr">alertname:</span> <span class="string">InstanceDown</span></span><br><span class="line">        <span class="attr">exp_alerts:</span></span><br><span class="line">          <span class="comment"># Alert 1.</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">exp_labels:</span></span><br><span class="line">              <span class="attr">severity:</span> <span class="string">page</span></span><br><span class="line">              <span class="attr">instance:</span> <span class="number">192.168</span><span class="number">.33</span><span class="number">.4</span><span class="string">:9090</span></span><br><span class="line">              <span class="attr">job:</span> <span class="string">prometheus</span></span><br><span class="line">              <span class="attr">ip_address:</span> <span class="number">192.168</span><span class="number">.33</span><span class="number">.4</span></span><br><span class="line">            <span class="attr">exp_annotations:</span></span><br><span class="line">              <span class="attr">summary:</span> <span class="string">"Instance 192.168.33.4:9090 down"</span></span><br><span class="line">              <span class="attr">description:</span> <span class="string">"192.168.33.4:9090 of job prometheus has been down for more than 5 minutes."</span></span><br><span class="line">      <span class="comment"># sd service alert 单元测试</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">eval_time:</span> <span class="string">10m</span></span><br><span class="line">        <span class="attr">alertname:</span> <span class="string">SdServiceDown</span></span><br><span class="line">        <span class="attr">exp_alerts:</span></span><br><span class="line">          <span class="comment"># service prom-alert-webhook 当alert的label和annotations 和 下面预期的一样则通过test</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">exp_labels:</span></span><br><span class="line">              <span class="attr">severity:</span> <span class="string">page</span></span><br><span class="line">              <span class="attr">instance:</span> <span class="number">192.168</span><span class="number">.33</span><span class="number">.1</span><span class="string">:8084</span></span><br><span class="line">              <span class="attr">job:</span> <span class="string">application</span></span><br><span class="line">              <span class="attr">ip_address:</span> <span class="number">192.168</span><span class="number">.33</span><span class="number">.1</span></span><br><span class="line">              <span class="attr">application:</span> <span class="string">prom-alert-webhook</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">application</span></span><br><span class="line">            <span class="attr">exp_annotations:</span></span><br><span class="line">              <span class="attr">summary:</span> <span class="string">"sd service prom-alert-webhook down "</span></span><br><span class="line">              <span class="attr">description:</span> <span class="string">"sd service prom-alert-webhook down"</span></span><br><span class="line">          <span class="comment"># service sub-system-a</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">exp_labels:</span></span><br><span class="line">              <span class="attr">severity:</span> <span class="string">page</span></span><br><span class="line">              <span class="attr">instance:</span> <span class="number">192.168</span><span class="number">.33</span><span class="number">.1</span><span class="string">:8081</span></span><br><span class="line">              <span class="attr">job:</span> <span class="string">application</span></span><br><span class="line">              <span class="attr">ip_address:</span> <span class="number">192.168</span><span class="number">.33</span><span class="number">.1</span></span><br><span class="line">              <span class="attr">application:</span> <span class="string">sub-system-a</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">application</span></span><br><span class="line">            <span class="attr">exp_annotations:</span></span><br><span class="line">              <span class="attr">summary:</span> <span class="string">"sd service sub-system-a down "</span></span><br><span class="line">              <span class="attr">description:</span> <span class="string">"sd service sub-system-a down"</span></span><br><span class="line">          <span class="comment"># service sub-system-b</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">exp_labels:</span></span><br><span class="line">              <span class="attr">severity:</span> <span class="string">page</span></span><br><span class="line">              <span class="attr">instance:</span> <span class="number">192.168</span><span class="number">.33</span><span class="number">.1</span><span class="string">:8082</span></span><br><span class="line">              <span class="attr">job:</span> <span class="string">application</span></span><br><span class="line">              <span class="attr">ip_address:</span> <span class="number">192.168</span><span class="number">.33</span><span class="number">.1</span></span><br><span class="line">              <span class="attr">application:</span> <span class="string">sub-system-b</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">application</span></span><br><span class="line">            <span class="attr">exp_annotations:</span></span><br><span class="line">              <span class="attr">summary:</span> <span class="string">"sd service sub-system-b down "</span></span><br><span class="line">              <span class="attr">description:</span> <span class="string">"sd service sub-system-b down"</span></span><br><span class="line">    <span class="comment"># Unit tests for promql expressions.</span></span><br><span class="line">    <span class="attr">promql_expr_test:</span></span><br><span class="line">      <span class="comment"># Unit test 1.</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">expr:</span> <span class="string">go_goroutines</span> <span class="string">&gt;</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">eval_time:</span> <span class="string">5m</span></span><br><span class="line">        <span class="attr">exp_samples:</span></span><br><span class="line">          <span class="comment"># Sample 1.</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">labels:</span> <span class="string">'go_goroutines&#123;instance="192.168.33.4:9090", ip_address="192.168.33.4", job="prometheus"&#125;'</span></span><br><span class="line">            <span class="attr">value:</span></span><br><span class="line">              <span class="number">70</span></span><br><span class="line">              <span class="comment"># Unit test 1.</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">expr:</span> <span class="string">up</span> <span class="string">&gt;</span> <span class="number">-1</span></span><br><span class="line">        <span class="attr">eval_time:</span> <span class="string">7m</span></span><br><span class="line">        <span class="attr">exp_samples:</span></span><br><span class="line">          <span class="comment"># Sample 2.</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">labels:</span> <span class="string">'up&#123;instance="192.168.33.4:9090", ip_address="192.168.33.4", job="prometheus"&#125;'</span></span><br><span class="line">            <span class="attr">value:</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h3 id="Grafana配置"><a href="#Grafana配置" class="headerlink" title="Grafana配置"></a>Grafana配置</h3><h3 id="Alertmanager配置"><a href="#Alertmanager配置" class="headerlink" title="Alertmanager配置"></a>Alertmanager配置</h3><p>检查alertmanager配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm -it --entrypoint=<span class="string">''</span> -v <span class="string">"<span class="variable">$PWD</span>/alertmanager_conf:/etc/alertmanager_conf"</span> prom/alertmanager:v0.21.0 amtool check-config /etc/alertmanager_conf/alertmanager.yml</span><br></pre></td></tr></table></figure>

<p>alertmanager.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">smtp_from:</span> <span class="string">lux@haoshudao.com</span></span><br><span class="line">  <span class="attr">smtp_smarthost:</span> <span class="string">smtp.qiye.aliyun.com:465</span></span><br><span class="line">  <span class="attr">smtp_auth_username:</span> <span class="string">****</span></span><br><span class="line">  <span class="attr">smtp_auth_password:</span> <span class="string">****</span></span><br><span class="line">  <span class="attr">smtp_require_tls:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">route:</span></span><br><span class="line">  <span class="attr">receiver:</span> <span class="string">"web.hook.db"</span></span><br><span class="line">  <span class="attr">group_by:</span> <span class="string">["alertname"]</span></span><br><span class="line">  <span class="attr">continue:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">group_wait:</span> <span class="string">10s</span></span><br><span class="line">  <span class="attr">group_interval:</span> <span class="string">5m</span></span><br><span class="line">  <span class="attr">repeat_interval:</span> <span class="string">1h</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">receiver:</span> <span class="string">"web.hook.db"</span></span><br><span class="line">      <span class="attr">continue:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">match:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">"application"</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">receiver:</span> <span class="string">"web.hook.dingding"</span></span><br><span class="line">      <span class="attr">continue:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">match:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">"application"</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">receiver:</span> <span class="string">"email.luxiang"</span></span><br><span class="line">      <span class="attr">continue:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">match:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">"application"</span></span><br><span class="line"><span class="attr">receivers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">"web.hook.dingding"</span></span><br><span class="line">    <span class="attr">webhook_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">"http://192.168.33.4:8060/dingtalk/webhook_legacy/send"</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">"web.hook.db"</span></span><br><span class="line">    <span class="attr">webhook_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">"http://192.168.33.4:9567/webhook"</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">"email.luxiang"</span></span><br><span class="line">    <span class="attr">email_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">to:</span> <span class="number">1374920889</span><span class="string">@qq.com</span></span><br><span class="line">        <span class="attr">send_resolved:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">inhibit_rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_match:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">"critical"</span></span><br><span class="line">    <span class="attr">target_match:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">"warning"</span></span><br><span class="line">    <span class="attr">equal:</span> <span class="string">["alertname",</span> <span class="string">"dev"</span><span class="string">,</span> <span class="string">"instance"</span><span class="string">]</span></span><br></pre></td></tr></table></figure>

<h3 id="Prometheus-webhook-dingtalk配置"><a href="#Prometheus-webhook-dingtalk配置" class="headerlink" title="Prometheus-webhook-dingtalk配置"></a>Prometheus-webhook-dingtalk配置</h3><p>config.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Request timeout</span></span><br><span class="line"><span class="comment"># timeout: 5s</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Customizable templates path</span></span><br><span class="line"><span class="comment"># templates:</span></span><br><span class="line"><span class="comment">#   - contrib/templates/legacy/template.tmpl</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## You can also override default template using `default_message`</span></span><br><span class="line"><span class="comment">## The following example to use the 'legacy' template from v0.3.0</span></span><br><span class="line"><span class="comment"># default_message:</span></span><br><span class="line"><span class="comment">#   title: '&#123;&#123; template "legacy.title" . &#125;&#125;'</span></span><br><span class="line"><span class="comment">#   text: '&#123;&#123; template "legacy.content" . &#125;&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Targets, previously was known as "profiles"</span></span><br><span class="line"><span class="attr">targets:</span></span><br><span class="line">  <span class="attr">webhook_legacy:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">https://oapi.dingtalk.com/robot/send?access_token=****</span></span><br><span class="line">    <span class="attr">secret:</span> <span class="string">****</span></span><br><span class="line">    <span class="comment"># Customize template content</span></span><br><span class="line">    <span class="comment">#message:</span></span><br><span class="line">      <span class="comment"># Use legacy template</span></span><br><span class="line">      <span class="comment">#title: '&#123;&#123; template "legacy.title" . &#125;&#125;'</span></span><br><span class="line">      <span class="comment">#text: '&#123;&#123; template "legacy.content" . &#125;&#125;'</span></span><br><span class="line">    <span class="attr">mention:</span></span><br><span class="line">      <span class="attr">all:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="Alertsnitch配置"><a href="#Alertsnitch配置" class="headerlink" title="Alertsnitch配置"></a>Alertsnitch配置</h3><p>表模型</p>
<p><img src="alertsnitch.png" alt="alertsnitch"></p>
<p>mysql-init.sql</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">PROCEDURE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> bootstrap;</span><br><span class="line"></span><br><span class="line">DELIMITER //</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> bootstrap()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">  <span class="keyword">SET</span> @<span class="keyword">exists</span> := (<span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">FROM</span> information_schema.tables I <span class="keyword">WHERE</span> I.table_name = <span class="string">"Model"</span> <span class="keyword">AND</span> I.table_schema = <span class="keyword">database</span>());</span><br><span class="line">  IF @exists IS NULL THEN</span><br><span class="line"></span><br><span class="line">    <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`Model`</span> (</span><br><span class="line">      <span class="string">`ID`</span> enum(<span class="string">'1'</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">      <span class="string">`version`</span> <span class="built_in">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">      PRIMARY <span class="keyword">KEY</span> (<span class="string">`ID`</span>)</span><br><span class="line">    ) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`Model`</span> (<span class="string">`version`</span>) <span class="keyword">VALUES</span> (<span class="string">"0.0.1"</span>);</span><br><span class="line"></span><br><span class="line">  ELSE</span><br><span class="line">    SIGNAL SQLSTATE '42000' <span class="keyword">SET</span> MESSAGE_TEXT=<span class="string">'Model Table Exists, quitting...'</span>;</span><br><span class="line">  <span class="keyword">END</span> <span class="keyword">IF</span>;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line">//</span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Execute the procedure</span></span><br><span class="line"><span class="keyword">CALL</span> bootstrap();</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Drop the procedure</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">PROCEDURE</span> bootstrap;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Create the rest of the tables</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`AlertGroup`</span> (</span><br><span class="line">	<span class="string">`ID`</span> <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">	<span class="string">`time`</span> <span class="built_in">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">	<span class="string">`receiver`</span> <span class="built_in">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">	<span class="string">`status`</span> <span class="built_in">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">	<span class="string">`externalURL`</span> <span class="built_in">TEXT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">	<span class="string">`groupKey`</span> <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">	<span class="keyword">KEY</span> <span class="string">`idx_time`</span> (<span class="string">`time`</span>) <span class="keyword">USING</span> BTREE,</span><br><span class="line">    <span class="keyword">KEY</span> <span class="string">`idx_status_ts`</span> (<span class="string">`status`</span>, <span class="string">`time`</span>) <span class="keyword">USING</span> BTREE,</span><br><span class="line">	PRIMARY <span class="keyword">KEY</span> (<span class="string">`ID`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`GroupLabel`</span> (</span><br><span class="line">	<span class="string">`ID`</span> <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    <span class="string">`AlertGroupID`</span> <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="string">`GroupLabel`</span> <span class="built_in">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="string">`Value`</span> <span class="built_in">VARCHAR</span>(<span class="number">1000</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (AlertGroupID) <span class="keyword">REFERENCES</span> AlertGroup (<span class="keyword">ID</span>) <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">CASCADE</span>,</span><br><span class="line">	PRIMARY <span class="keyword">KEY</span> (<span class="string">`ID`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`CommonLabel`</span> (</span><br><span class="line">	<span class="string">`ID`</span> <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    <span class="string">`AlertGroupID`</span> <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="string">`Label`</span> <span class="built_in">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="string">`Value`</span> <span class="built_in">VARCHAR</span>(<span class="number">1000</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (AlertGroupID) <span class="keyword">REFERENCES</span> AlertGroup (<span class="keyword">ID</span>) <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">CASCADE</span>,</span><br><span class="line">	PRIMARY <span class="keyword">KEY</span> (<span class="string">`ID`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`CommonAnnotation`</span> (</span><br><span class="line">	<span class="string">`ID`</span> <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    <span class="string">`AlertGroupID`</span> <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="string">`Annotation`</span> <span class="built_in">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="string">`Value`</span> <span class="built_in">VARCHAR</span>(<span class="number">1000</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (AlertGroupID) <span class="keyword">REFERENCES</span> AlertGroup (<span class="keyword">ID</span>) <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">CASCADE</span>,</span><br><span class="line">	PRIMARY <span class="keyword">KEY</span> (<span class="string">`ID`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`Alert`</span> (</span><br><span class="line">	<span class="string">`ID`</span> <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    <span class="string">`alertGroupID`</span> <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">	<span class="string">`status`</span> <span class="built_in">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="string">`startsAt`</span> DATETIME <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="string">`endsAt`</span> DATETIME <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">	<span class="string">`generatorURL`</span> <span class="built_in">TEXT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (alertGroupID) <span class="keyword">REFERENCES</span> AlertGroup (<span class="keyword">ID</span>) <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">CASCADE</span>,</span><br><span class="line">	PRIMARY <span class="keyword">KEY</span> (<span class="string">`ID`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`AlertLabel`</span> (</span><br><span class="line">	<span class="string">`ID`</span> <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    <span class="string">`AlertID`</span> <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="string">`Label`</span> <span class="built_in">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="string">`Value`</span> <span class="built_in">VARCHAR</span>(<span class="number">1000</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (AlertID) <span class="keyword">REFERENCES</span> Alert (<span class="keyword">ID</span>) <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">CASCADE</span>,</span><br><span class="line">	PRIMARY <span class="keyword">KEY</span> (<span class="string">`ID`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`AlertAnnotation`</span> (</span><br><span class="line">	<span class="string">`ID`</span> <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    <span class="string">`AlertID`</span> <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="string">`Annotation`</span> <span class="built_in">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="string">`Value`</span> <span class="built_in">VARCHAR</span>(<span class="number">1000</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (AlertID) <span class="keyword">REFERENCES</span> Alert (<span class="keyword">ID</span>) <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">CASCADE</span>,</span><br><span class="line">	PRIMARY <span class="keyword">KEY</span> (<span class="string">`ID`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Alert </span><br><span class="line">    <span class="keyword">ADD</span> <span class="string">`fingerprint`</span> <span class="built_in">TEXT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"><span class="keyword">UPDATE</span> <span class="string">`Model`</span>  <span class="keyword">SET</span> <span class="string">`version`</span>=<span class="string">"0.1.0"</span>;</span><br></pre></td></tr></table></figure>

<h3 id="docker-compose启动"><a href="#docker-compose启动" class="headerlink" title="docker-compose启动"></a>docker-compose启动</h3><p>docker-compose.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">"3"</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">    <span class="attr">prometheus:</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">prom/prometheus:v2.26.0</span></span><br><span class="line">        <span class="attr">container_name:</span> <span class="string">prometheus</span></span><br><span class="line">        <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="number">9090</span><span class="string">:9090</span></span><br><span class="line">        <span class="attr">environment:</span> </span><br><span class="line">            <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--config.file=/etc/prometheus_conf/prometheus.yml</span></span><br><span class="line">        <span class="attr">volumes:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">./prometheus_conf:/etc/prometheus_conf:ro</span></span><br><span class="line">    <span class="attr">alertmanager:</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">prom/alertmanager:v0.21.0</span></span><br><span class="line">        <span class="attr">container_name:</span> <span class="string">alertmanager</span></span><br><span class="line">        <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="number">9093</span><span class="string">:9093</span></span><br><span class="line">        <span class="attr">environment:</span> </span><br><span class="line">            <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--config.file=/etc/altermanager_conf/altermanager.yml</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--web.external-url=http://192.168.33.4:9093/</span></span><br><span class="line">            <span class="comment"># test</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--log.level=debug</span></span><br><span class="line">        <span class="attr">volumes:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">./altermanager_conf:/etc/altermanager_conf:ro</span></span><br><span class="line">    <span class="comment"># alertmanager webhook集成钉钉（可选）</span></span><br><span class="line">    <span class="attr">prometheus-webhook-dingtalk:</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">timonwong/prometheus-webhook-dingtalk:latest</span></span><br><span class="line">        <span class="attr">container_name:</span> <span class="string">prometheus-webhook-dingtalk</span></span><br><span class="line">        <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="number">8060</span><span class="string">:8060</span></span><br><span class="line">        <span class="attr">environment:</span> </span><br><span class="line">            <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--config.file=/etc/prometheus-webhook-dingtalk/config.yml</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--web.enable-ui</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--web.enable-lifecycle</span></span><br><span class="line">        <span class="attr">volumes:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">./prometheus-webhook-dingtalk:/etc/prometheus-webhook-dingtalk:ro</span></span><br><span class="line">    <span class="comment"># alertmanager database集成（可选）</span></span><br><span class="line">    <span class="attr">alertsnitch:</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">luxiang0412/alertsnitch:0.2.1</span></span><br><span class="line">        <span class="attr">container_name:</span> <span class="string">alertsnitch</span></span><br><span class="line">        <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="number">9567</span><span class="string">:9567</span></span><br><span class="line">        <span class="attr">environment:</span> </span><br><span class="line">            <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">        <span class="attr">environment:</span> </span><br><span class="line">            <span class="attr">ALERTSNITCH_DSN:</span> <span class="string">'root:password@tcp(192.168.33.4:3306)/dataplatform_test'</span></span><br><span class="line">            <span class="attr">ALERSTNITCH_BACKEND:</span> <span class="string">'mysql'</span></span><br><span class="line">    <span class="attr">grafana:</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">grafana/grafana:7.5.5</span></span><br><span class="line">        <span class="attr">container_name:</span> <span class="string">grafana</span></span><br><span class="line">        <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">"3000:3000"</span></span><br><span class="line">        <span class="attr">environment:</span> </span><br><span class="line">            <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br></pre></td></tr></table></figure>

<h2 id="Spring-boot-自定义指标"><a href="#Spring-boot-自定义指标" class="headerlink" title="Spring-boot 自定义指标"></a>Spring-boot 自定义指标</h2><p>可以在自己项目中暴露业务指标，然后Prometheus抓取指标存储到TSDB（Time series database）；<br>然后通过grafana定制自己的监控面板，还可以定制自己的业务告警规则，也可以在项目中通过HTTP API查询Prometheus数据作展示；</p>
<p>依赖</p>
<p>pom.xml （版本自己选择）</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Spring boot actuator to expose metrics endpoint --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Micormeter core dependecy  --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.micrometer<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>micrometer-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;io.micrometer.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Micrometer Prometheus registry  --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.micrometer<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>micrometer-registry-prometheus<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;io.micrometer.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<hr>
<blockquote>
<p><a href="https://docs.spring.io/spring-boot/docs/current/reference/html/appendix-application-properties.html#common-application-properties-actuator" target="_blank" rel="noopener">common-application-properties-actuator</a></p>
</blockquote>
<p>application.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoint:</span></span><br><span class="line">    <span class="comment"># 启用metrics端点</span></span><br><span class="line">    <span class="attr">metrics.enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 启用prometheus端点</span></span><br><span class="line">    <span class="attr">prometheus.enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 指标暴露到prometheus端点</span></span><br><span class="line">  <span class="attr">metrics.export.prometheus.enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span></span><br><span class="line">          <span class="comment">#- 'health'</span></span><br><span class="line">          <span class="comment">#- 'info'</span></span><br><span class="line">          <span class="comment">#- 'metrics'</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">'prometheus'</span></span><br><span class="line">          <span class="comment">#- 'heapdump'</span></span><br></pre></td></tr></table></figure>
<hr>
<p>自定义业务指标</p>
<p><a href="https://prometheus.io/docs/concepts/metric_types/" target="_blank" rel="noopener">有四种类型的指标</a></p>
<table>
<thead>
<tr>
<th align="left">类型</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Counter</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">Gauge</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">Histogram</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">Summary</td>
<td align="left">-</td>
</tr>
</tbody></table>
<p>test metrics</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io.micrometer.core.instrument.Counter;</span><br><span class="line"><span class="keyword">import</span> io.micrometer.core.instrument.Gauge;</span><br><span class="line"><span class="keyword">import</span> io.micrometer.core.instrument.MeterRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> luxiang</span></span><br><span class="line"><span class="comment"> * description  //自定义指标注册</span></span><br><span class="line"><span class="comment"> * create       2021-04-29 11:06</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomizeMetrics</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 应用名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String applicationName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MeterRegistry meterRegistry;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计数器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter counter;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 状态</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">double</span>[] status = &#123;<span class="number">1</span>D&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构造方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> meterRegistry meter registry</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> applicationName 应用名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomizeMetrics</span><span class="params">(MeterRegistry meterRegistry,</span></span></span><br><span class="line"><span class="function"><span class="params">                            @Value(<span class="string">"$&#123;spring.application.name&#125;"</span>)</span> String applicationName) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.meterRegistry = meterRegistry;</span><br><span class="line">        <span class="keyword">this</span>.applicationName = applicationName;</span><br><span class="line">        counter = Counter.builder(<span class="string">"sd.count"</span>)</span><br><span class="line">                .tag(<span class="string">"application"</span>, applicationName)</span><br><span class="line">                .description(<span class="string">"计数器"</span>)</span><br><span class="line">                .register(meterRegistry);</span><br><span class="line"></span><br><span class="line">        Gauge.builder(<span class="string">"sd.service.status"</span>, status, e -&gt; e[<span class="number">0</span>])</span><br><span class="line">                .tag(<span class="string">"application"</span>, applicationName)</span><br><span class="line">                .description(<span class="string">"服务状态 0停止 1启动"</span>)</span><br><span class="line">                .register(meterRegistry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理计数器 +1</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processCounter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        counter.increment();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 改变状态 0-&gt;1 1-&gt;0</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processStatus</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (status[<span class="number">0</span>] == <span class="number">0</span>) &#123;</span><br><span class="line">            status[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            status[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://prometheus.io/docs/prometheus/latest/getting_started/" target="_blank" rel="noopener">Prometheus</a></li>
<li><a href="https://prometheus.io/docs/alerting/latest/overview/" target="_blank" rel="noopener">Alertmanager</a></li>
<li><a href="https://grafana.com/docs/grafana/latest/datasources/prometheus/" target="_blank" rel="noopener">Grafana Prometheus</a></li>
<li><a href="https://grafana.com/grafana/dashboards" target="_blank" rel="noopener">Grafana dashboard</a></li>
<li><a href="https://github.com/timonwong/prometheus-webhook-dingtalk" target="_blank" rel="noopener">Prometheus webhook dingtalk</a></li>
<li><a href="https://github.com/yakshaving-art/alertsnitch" target="_blank" rel="noopener">Alertsnitch</a></li>
<li><a href="https://prometheus.io/docs/operating/integrations/#alertmanager-webhook-receiver" target="_blank" rel="noopener">Alertmanager webhook receiver</a></li>
<li><a href="https://www.yxingxing.net/archives/alertmanager-20191218-config" target="_blank" rel="noopener">Alertmanager 配置</a></li>
</ul>


<!--<a href="https://luxiang.org/2021/05/05/Prometheus%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/#disqus_thread" class="article-comment-link">Comments</a>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = ''; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
-->
<div style="display:none">
    <script src="http://s4.cnzz.com/stat.php?id=&web_id="
        language="JavaScript"></script>script>
</div>


<script src="/js/jquery-3.5.1.min.js"></script>
<script src="/js/clipboard.min.js"></script>
<script src="/js/clipboard-use.js"></script>

    <script src='https://unpkg.com/mermaid@8.9.1/dist/mermaid.min.js'></script>
    <script>
      if (window.mermaid) {
        mermaid.initialize({theme: 'forest'});
      }
    </script>
  



</body>
</html>